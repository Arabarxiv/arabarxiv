# نظام إدارة الصلاحيات - Authorization System

## نظرة عامة

تم تطوير نظام شامل لإدارة الصلاحيات في منصة ArabArxiv لضمان الوصول الآمن والمتحكم إلى مختلف أجزاء المنصة. النظام يوفر رسائل خطأ واضحة ومفيدة للمستخدمين مع اقتراحات للحلول.

## أنواع الصلاحيات

### 1. تسجيل الدخول المطلوب (Login Required)
- **الوصف**: يتطلب من المستخدم تسجيل الدخول للوصول إلى الصفحة
- **الرسالة**: "يجب تسجيل الدخول للوصول إلى هذه الصفحة"
- **الحل المقترح**: زر "تسجيل الدخول" يأخذ المستخدم إلى صفحة تسجيل الدخول

### 2. تأكيد البريد الإلكتروني (Email Confirmation Required)
- **الوصف**: يتطلب من المستخدم تأكيد بريده الإلكتروني
- **الرسالة**: "يجب تأكيد بريدك الإلكتروني قبل إنشاء منشور جديد"
- **الحل المقترح**: زر "إعادة إرسال بريد التأكيد" لإرسال رابط التأكيد مرة أخرى

### 3. صلاحيات المراجع (Moderator Required)
- **الوصف**: يتطلب أن يكون المستخدم مراجعًا أو موظفًا
- **الرسالة**: "يجب أن تكون مراجعًا للوصول إلى هذه الصفحة"
- **الحل المقترح**: زر "طلب أن تصبح مراجعًا" لتقديم طلب الانضمام لفريق المراجعين

### 4. صلاحيات المؤلف (Author Required)
- **الوصف**: يتطلب أن يكون المستخدم هو المؤلف الأصلي للمنشور
- **الرسالة**: "يمكن فقط للمؤلف الأصلي حذف أو تعديل هذا المنشور"
- **الحل المقترح**: زر "عرض المنشور" للعودة إلى قائمة المنشورات

### 5. إكمال الملف الشخصي (Profile Completion Required)
- **الوصف**: يتطلب إكمال الملف الشخصي للمستخدم
- **الرسالة**: "يجب إكمال ملفك الشخصي قبل الوصول إلى هذه الصفحة"
- **الحل المقترح**: زر "إكمال الملف الشخصي" للانتقال إلى صفحة تعديل الملف الشخصي

## المكونات الرئيسية

### 1. الديكوراتورات (Decorators)

#### `@email_confirmation_required`
```python
@email_confirmation_required
def create_post(request):
    # الكود هنا
```

#### `@moderator_required`
```python
@moderator_required
def review_post(request):
    # الكود هنا
```

#### `@author_required`
```python
@author_required
def delete_post(request, post_id):
    # الكود هنا
```

#### `@profile_completion_required`
```python
@profile_completion_required
def some_view(request):
    # الكود هنا
```

### 2. الوسيط (Middleware)

تم إنشاء `AuthorizationMiddleware` للتحقق من الصلاحيات على مستوى التطبيق:

```python
class AuthorizationMiddleware:
    def __call__(self, request):
        # التحقق من الصلاحيات
        # إرجاع صفحة خطأ مناسبة إذا لزم الأمر
```

### 3. معالج الأخطاء المخصص (Custom Error Handler)

```python
def custom_403_error(request, exception=None):
    # معالجة أخطاء 403 Forbidden
```

## الصفحات المحمية

### صفحات تتطلب تسجيل الدخول:
- `/user_profile` - الملف الشخصي
- `/create-post` - إنشاء منشور
- `/create-translation-post` - إنشاء منشور ترجمة
- `/delete_post/<id>/` - حذف منشور
- `/review` - مراجعة المنشورات
- `/assign_mod` - تعيين مراجع

### صفحات تتطلب تأكيد البريد:
- `/create-post` - إنشاء منشور
- `/create-translation-post` - إنشاء منشور ترجمة
- `/become_reviewer` - طلب أن تصبح مراجعًا

### صفحات تتطلب صلاحيات المراجع:
- `/review` - مراجعة المنشورات
- `/assign_mod` - تعيين مراجع

## قالب صفحة الخطأ

تم إنشاء قالب `authorization_error.html` يوفر:

1. **أيقونات مختلفة** لكل نوع خطأ
2. **رسائل واضحة** باللغة العربية
3. **أزرار إجراءات** لحل المشكلة
4. **روابط مساعدة** إضافية
5. **تصميم متجاوب** يعمل على جميع الأجهزة

## كيفية الاستخدام

### للمطورين:

1. **إضافة ديكوراتور للوظيفة**:
```python
@login_required
@email_confirmation_required
def my_view(request):
    # الكود هنا
```

2. **إضافة فحص في الوسيط**:
```python
# في middleware.py
email_confirmation_required_urls = [
    'my_new_view',
]
```

### للمستخدمين:

1. **عند مواجهة خطأ في الصلاحيات**، ستظهر صفحة واضحة تشرح المشكلة
2. **انقر على الزر المقترح** لحل المشكلة
3. **استخدم الروابط الإضافية** للحصول على مساعدة إضافية

## اختبار النظام

تم إنشاء صفحة اختبار `/test-auth/` لاختبار جميع أنواع الصلاحيات:

1. **بدون تسجيل دخول**: سيظهر خطأ تسجيل الدخول
2. **مع تسجيل دخول بدون تأكيد البريد**: سيظهر خطأ تأكيد البريد
3. **مع تأكيد البريد بدون صلاحيات المراجع**: سيظهر خطأ صلاحيات المراجع
4. **مع جميع الصلاحيات**: ستظهر رسالة نجاح

## الأمان

- جميع الفحوصات تتم على مستوى الخادم
- لا يمكن تجاوز الفحوصات من جانب العميل
- يتم تسجيل محاولات الوصول غير المصرح به
- رسائل الخطأ لا تكشف معلومات حساسة

## التخصيص

يمكن تخصيص النظام بسهولة:

1. **إضافة أنواع صلاحيات جديدة** في الديكوراتورات
2. **تعديل الرسائل** في قالب الخطأ
3. **إضافة فحوصات جديدة** في الوسيط
4. **تخصيص الأيقونات والألوان** في CSS

## الدعم

للمساعدة أو الإبلاغ عن مشاكل:
- تواصل مع فريق التطوير
- راجع دليل المؤلفين
- اطلع على فريق العمل والمراجعين 