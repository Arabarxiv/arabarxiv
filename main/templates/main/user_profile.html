{% extends 'main/base.html' %}
{% load crispy_forms_tags %}
{% block title %}الملف الشخصي{% endblock %}
{% block content %}
<style>
  /* Custom styling for grouped category dropdown */
  select option[disabled] {
    font-weight: bold;
    background-color: #e9ecef;
    color: #495057;
    padding: 8px 12px;
    border-bottom: 1px solid #dee2e6;
  }
  
  select option:not([disabled]) {
    padding-left: 20px;
    background-color: white;
  }
  
  select option:not([disabled]):hover {
    background-color: #f8f9fa;
  }
  
  /* Existing styles */
     .badge-info {
     background-color: #0056b3 !important;
     color: white !important;
     font-weight: bold !important;
   }
   
   .badge-secondary {
     background-color: #495057 !important;
     color: white !important;
     font-weight: bold !important;
   }
  
  .btn-group .btn {
    margin-right: 2px;
  }
  
     .table th {
     background-color: #e9ecef !important;
     border-color: #dee2e6 !important;
     color: #495057 !important;
     font-weight: bold !important;
   }
  
  .table td {
    vertical-align: middle;
  }
  
     .btn-info {
     background-color: #0056b3 !important;
     border-color: #0056b3 !important;
     color: white !important;
     font-weight: 500 !important;
   }
   
   .btn-info:hover {
     background-color: #004085 !important;
     border-color: #004085 !important;
     color: white !important;
   }
  
  .actions-column {
    min-width: 400px;
    width: 400px;
  }
  
  .btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
  }
  
     .btn-group .btn {
     flex: 0 0 auto;
     white-space: nowrap;
   }
   
       .profile-card {
      min-width: 350px;
      width: 100%;
      text-align: right;
    }
    
    .badge-warning {
      background-color: #ffc107 !important;
      color: #212529 !important;
      font-weight: bold !important;
    }
    
    .badge-primary {
      background-color: #007bff !important;
      color: white !important;
      font-weight: bold !important;
    }
    
    .who-am-i-content {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #28a745;
      margin-bottom: 15px;
      max-height: 350px;
      overflow-y: auto;
    }
    
    .who-am-i-content p {
      margin-bottom: 0;
      line-height: 1.6;
      color: #495057;
    }
    
    .who-am-i-content .text-muted {
      font-style: italic;
    }
    
    /* Modal styling for Who am I */
    #whoAmIModal .modal-dialog {
      max-width: 800px;
    }
    
    #whoAmIModal .modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }
    
    #whoAmIModal textarea {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
</style>
 <div class="container">
   <div class="row">
     <div class="col-md-5">
          <!-- User Info Card -->
          <div class="card mt-4">
            <div class="card-body" style="padding: 15px;">
              <h2 class="card-title" style="font-size: 1.5em; margin-bottom: 15px;">{{ user.username }}</h2>
              
              <!-- Name -->
              <div class="profile-attribute" style="margin-bottom: 8px;">
                <p style="margin-bottom: 5px;"><strong>الاسم الكامل:</strong> {{ user.first_name }} {{ user.last_name }} <button class="btn btn-link" data-toggle="modal" data-target="#nameModal"><i class="fas fa-edit"></i></button></p>
              </div>
              
              <!-- Email -->
              <div class="profile-attribute" style="margin-bottom: 8px;">
                <p style="margin-bottom: 5px;"><strong>البريد الإلكتروني:</strong> {{ user.email }} <button class="btn btn-link" data-toggle="modal" data-target="#emailModal"><i class="fas fa-edit"></i></button></p>
                {% if not user.is_superuser and not user.userprofile.email_confirmed %}
                  <small class="text-warning">البريد الإلكتروني غير مؤكد</small>
                {% else %}
                  <small class="text-success">البريد الإلكتروني مؤكد</small>
                {% endif %}
              </div>
              
              <!-- Password Reset -->
              <div class="profile-attribute" style="margin-bottom: 8px;">
                <p style="margin-bottom: 5px;"><strong>كلمة المرور:</strong> <button class="btn btn-link" data-toggle="modal" data-target="#passwordModal"><i class="fas fa-key"></i> تغيير كلمة المرور</button></p>
              </div>
              
              <!-- Affiliation -->
              <div class="profile-attribute" style="margin-bottom: 8px;">
                <p style="margin-bottom: 5px;"><strong>الانتماء:</strong> {{ user.userprofile.affiliation }} <button class="btn btn-link" data-toggle="modal" data-target="#affiliationModal"><i class="fas fa-edit"></i></button></p>
              </div>
              
              <!-- Country -->
              <div class="profile-attribute" style="margin-bottom: 8px;">
                <p style="margin-bottom: 5px;"><strong>الدولة:</strong> {{ user.userprofile.get_country_display }} <button class="btn btn-link" data-toggle="modal" data-target="#countryModal"><i class="fas fa-edit"></i></button></p>
              </div>
              
              <!-- Website -->
              <div class="profile-attribute" style="margin-bottom: 8px;">
                <p style="margin-bottom: 5px;"><strong>الموقع الإلكتروني:</strong> {{ user.userprofile.website }} <button class="btn btn-link" data-toggle="modal" data-target="#websiteModal"><i class="fas fa-edit"></i></button></p>
              </div>
              
              <!-- Career -->
              <div class="profile-attribute" style="margin-bottom: 8px;">
                <p style="margin-bottom: 5px;"><strong>المهنة:</strong> {{ user.userprofile.career }} <button class="btn btn-link" data-toggle="modal" data-target="#careerModal"><i class="fas fa-edit"></i></button></p>
              </div>
              
              <!-- Main Category -->
              <div class="profile-attribute" style="margin-bottom: 8px;">
                <p style="margin-bottom: 5px;"><strong>التصنيف الرئيسي:</strong> {{ user.userprofile.main_category }} <button class="btn btn-link" data-toggle="modal" data-target="#mainCategoryModal"><i class="fas fa-edit"></i></button></p>
              </div>
            </div>
          </div>
     </div>
     
     <!-- Who am I Section -->
     <div class="col-md-7">
       <div class="card mt-4">
         <div class="card-body" style="padding: 25px;">
           <h3 class="card-title" style="font-size: 1.8em; margin-bottom: 20px;">من أنا</h3>
           <div class="who-am-i-content" style="line-height: 1.8; font-size: 1.3em;">
             {% if user.userprofile.who_am_i %}
               <p>{{ user.userprofile.who_am_i|linebreaks }}</p>
             {% else %}
               <p class="text-muted">لم يتم إضافة ملخص بعد.</p>
             {% endif %}
           </div>
           <button class="btn btn-primary btn-sm mt-3" data-toggle="modal" data-target="#whoAmIModal">
             <i class="fas fa-edit"></i> تعديل
           </button>
         </div>
       </div>
     </div>
     

   </div>
   
   <div class="row">
     <div class="col-md-12">

          <!-- Drafts Card -->
          <div class="card mt-4">
           <div class="card-body">
               <h2 class="card-title">المسودات</h2>
               {% if drafts %}
               <table class="table table-bordered">
                   <thead>
                                              <tr>
                            <th>العنوان</th>
                            <th>النوع</th>
                            <th>تاريخ الإنشاء</th>
                            <th>آخر تحديث</th>
                            <th class="actions-column">الإجراءات</th>
                        </tr>
                   </thead>
                   <tbody>
                       {% for draft in drafts %}
                               <tr>
                                   <td><strong>{{ draft.title }}</strong></td>
                                   <td>
                                       {% if draft.is_translation %}
                                           <span class="badge badge-warning">مترجم</span>
                                       {% else %}
                                           <span class="badge badge-primary">أصلي</span>
                                       {% endif %}
                                   </td>
                                   <td>{{ draft.created_at|date:"F j, Y" }} {{ draft.created_at|time:"g:i A" }}</td>
                                   <td>{{ draft.updated_at|date:"F j, Y" }} {{ draft.updated_at|time:"g:i A" }}</td>
                                   <td class="actions-column">
                                      <div class="btn-group" role="group">
                                        <!-- Submit Article/Translation Button -->
                                        {% if draft.is_translation %}
                                            <form action="{% url 'submit_translation_draft' draft.id %}" method="post" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('هل تريد تقديم هذه المسودة كترجمة؟')">
                                                  <i class="fas fa-paper-plane"></i> تقديم الترجمة
                                                </button>
                                            </form>
                                        {% else %}
                                            <form action="{% url 'submit_draft' draft.id %}" method="post" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('هل تريد تقديم هذه المسودة كمقال؟')">
                                                  <i class="fas fa-paper-plane"></i> تقديم المقال
                                                </button>
                                            </form>
                                        {% endif %}
                                        <!-- Edit Button -->
                                        <a href="{% url 'edit_post' draft.id %}" class="btn btn-primary btn-sm">
                                          <i class="fas fa-edit"></i> تعديل
                                        </a>
                                        <!-- Delete Button -->
                                        <form action="{% url 'delete_post' draft.id %}" method="post" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('هل أنت متأكد من حذف هذه المسودة؟')">حذف</button>
                                        </form>
                                      </div>
                                    </td>
                               </tr>
                       {% endfor %}
                   </tbody>
               </table>
               {% else %}
               <p class="text-muted">لا توجد مسودات حالياً.</p>
               {% endif %}
           </div>
       </div>

          <!-- Submitted Posts Card -->
          <div class="card mt-4">
           <div class="card-body">
               <h2 class="card-title">قائمة المشاركات</h2>
               <table class="table table-bordered">
                   <thead>
                                              <tr>
                            <th>العنوان</th>
                            <th>النوع</th>
                            <th>تاريخ التقديم</th>
                            <th>الحالة</th>
                            <th>المشاهدات</th>
                            <th>التعليقات</th>
                            <th class="actions-column">الإجراءات</th>
                        </tr>
                   </thead>
                   <tbody>
                       {% for post in posts %}
                           {% if post.author == user %}
                               <tr>
                                   <td><strong>{{ post.title }}</strong></td>
                                   <td>
                                       {% if post.is_translation %}
                                           <span class="badge badge-warning">مترجم</span>
                                       {% else %}
                                           <span class="badge badge-primary">أصلي</span>
                                       {% endif %}
                                   </td>
                                   <td>{{ post.created_at|date:"F j, Y" }} {{ post.created_at|time:"g:i A" }}</td>
                                   <td>
                                     {% if post.status == "Approved" %}
                                     تم الموافقة
                                     {% elif post.status == "Rejected" %}
                                     لم يتم الموافقة
                                 {% else %}
                                     قيد الإنتظار
                                 {% endif %}
                                   </td>
                                   <td>
                                     <span class="badge badge-info">{{ post.get_total_view_count }}</span>
                                   </td>
                                   <td>
                                     <span class="badge badge-secondary">{{ post.get_comment_count }}</span>
                                   </td>
                                                                      <td class="actions-column">
                                      <div class="btn-group" role="group">
                                        <!-- More Info Button -->
                                        <a href="{% url 'post_detail_by_meaningful_id' post.meaningful_id %}" class="btn btn-info btn-sm">
                                          <i class="fas fa-info-circle"></i> المزيد من المعلومات
                                        </a>
                                        <!-- Edit Button - Show for all posts -->
                                        <a href="{% url 'edit_post' post.id %}" class="btn btn-primary btn-sm"
                                           {% if post.status == "Approved" %}
                                           onclick="return confirm('هذا المنشور تمت الموافقة عليه. عند التعديل سيتم إعادة إرساله للمراجعة. هل تريد المتابعة؟')"
                                           {% endif %}>
                                          {% if post.status == "Approved" %}
                                            تعديل (إعادة مراجعة)
                                          {% else %}
                                            تعديل
                                          {% endif %}
                                        </a>
                                        <!-- Request Re-review Button - Show for rejected posts -->
                                        {% if post.status == "Rejected" %}
                                        <form action="{% url 'request_re_review' post.id %}" method="post" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('هل تريد طلب إعادة مراجعة لهذا المقال؟')">
                                              <i class="fas fa-redo"></i> طلب إعادة مراجعة
                                            </button>
                                        </form>
                                        {% endif %}
                                        <!-- Delete Button -->
                                        <form action="{% url 'delete_post' post.id %}" method="post" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('هل أنت متأكد من حذف هذا المنشور؟')">حذف</button>
                                        </form>
                                      </div>
                                    </td>
                               </tr>
                           {% endif %}
                       {% endfor %}
                   </tbody>
               </table>
           </div>
       </div>

          <!-- Reviewed Posts Card -->
          {% if reviewed_posts %}
          <div class="card mt-4">
           <div class="card-body">
               <h2 class="card-title">المشاركات التي تمت مراجعتها</h2>
               <table class="table table-bordered">
                   <thead>
                       <tr>
                           <th>العنوان</th>
                           <th>المؤلف</th>
                           <th>النوع</th>
                           <th>تاريخ المراجعة</th>
                           <th>الحالة</th>
                           <th>المشاهدات</th>
                           <th>التعليقات</th>
                           <th class="actions-column">الإجراءات</th>
                       </tr>
                   </thead>
                   <tbody>
                       {% for post in reviewed_posts %}
                           <tr>
                               <td><strong>{{ post.title }}</strong></td>
                               <td>{{ post.author.username }}</td>
                               <td>
                                   {% if post.is_translation %}
                                       <span class="badge badge-warning">مترجم</span>
                                   {% else %}
                                       <span class="badge badge-primary">أصلي</span>
                                   {% endif %}
                               </td>
                               <td>{{ post.updated_at|date:"F j, Y" }} {{ post.updated_at|time:"g:i A" }}</td>
                               <td>
                                 {% if post.status == "Approved" %}
                                 <span style="color: #28a745;">تم الموافقة</span>
                                 {% elif post.status == "Rejected" %}
                                 <span style="color: #dc3545;">لم يتم الموافقة</span>
                                 {% else %}
                                 <span style="color: #ffc107;">قيد الإنتظار</span>
                                 {% endif %}
                               </td>
                               <td>
                                 <span class="badge badge-info">{{ post.get_total_view_count }}</span>
                               </td>
                               <td>
                                 <span class="badge badge-secondary">{{ post.get_comment_count }}</span>
                               </td>
                               <td class="actions-column">
                                 <div class="btn-group" role="group">
                                   <a href="{% url 'post_detail_by_meaningful_id' post.meaningful_id %}" class="btn btn-info btn-sm">
                                     <i class="fas fa-info-circle"></i> المزيد من المعلومات
                                   </a>
                                 </div>
                               </td>
                           </tr>
                       {% endfor %}
                   </tbody>
               </table>
           </div>
       </div>
       {% endif %}
       <div class="mt-4">
         <p>إذا كان لديك أي استفسار أو مشكلة، يُرجى التواصل معنا عبر البريد الإلكتروني:</p>
         <p><strong>submission_arabarxiv@gmail.com</strong></p>
     </div>
   </div>

          <!-- Name Edit Modal -->
          <div class="modal fade" id="nameModal" tabindex="-1" role="dialog" aria-labelledby="nameModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="nameModalLabel">تعديل الاسم</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form method="post" action="/user_profile">
                    {% csrf_token %}
                    {{ name_form|crispy }}
                    <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Email Edit Modal -->
          <div class="modal fade" id="emailModal" tabindex="-1" role="dialog" aria-labelledby="emailModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="emailModalLabel">تعديل البريد الإلكتروني</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form method="post" action="/user_profile">
                    {% csrf_token %}
                    {{ email_form|crispy }}
                    <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Password Reset Modal -->
          <div class="modal fade" id="passwordModal" tabindex="-1" role="dialog" aria-labelledby="passwordModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="passwordModalLabel">إعادة تعيين كلمة المرور</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p>سيتم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني: <strong>{{ user.email }}</strong></p>
                  <form method="post" action="{% url 'password_reset' %}">
                    {% csrf_token %}
                    <input type="hidden" name="email" value="{{ user.email }}">
                    <button type="submit" class="btn btn-primary">إرسال رابط إعادة التعيين</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Affiliation Edit Modal -->
          <div class="modal fade" id="affiliationModal" tabindex="-1" role="dialog" aria-labelledby="affiliationModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="affiliationModalLabel">تعديل الانتماء</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form method="post" action="/user_profile">
                    {% csrf_token %}
                    {{ affiliation_form|crispy }}
                    <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Country Edit Modal -->
          <div class="modal fade" id="countryModal" tabindex="-1" role="dialog" aria-labelledby="countryModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="countryModalLabel">تعديل الدولة</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form method="post" action="/user_profile">
                    {% csrf_token %}
                    {{ country_form|crispy  }}
                    <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Website Edit Modal -->
          <div class="modal fade" id="websiteModal" tabindex="-1" role="dialog" aria-labelledby="websiteModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="websiteModalLabel">تعديل الموقع الإلكتروني</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form method="post" action="/user_profile">
                    {% csrf_token %}
                    {{ website_form.as_p }}
                    <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Career Edit Modal -->
          <div class="modal fade" id="careerModal" tabindex="-1" role="dialog" aria-labelledby="careerModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="careerModalLabel">تعديل المهنة</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form method="post" action="/user_profile">
                    {% csrf_token %}
                    {{ career_form.as_p }}
                    <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Main Category Edit Modal -->
          <div class="modal fade" id="mainCategoryModal" tabindex="-1" role="dialog" aria-labelledby="mainCategoryModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="mainCategoryModalLabel">تعديل التصنيف الرئيسي</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form method="post" action="/user_profile">
                    {% csrf_token %}
                    {{ main_category_form.as_p }}
                    <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Who am I Edit Modal -->
          <div class="modal fade" id="whoAmIModal" tabindex="-1" role="dialog" aria-labelledby="whoAmIModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="whoAmIModalLabel">تعديل "من أنا"</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form method="post" action="/user_profile">
                    {% csrf_token %}
                    {{ who_am_i_form.as_p }}
                    <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
                 </div>
       </div>
     </div>
</div>
</div>

<script>
// Enhanced category dropdown functionality
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.querySelector('select[name="main_category"]');
    if (categorySelect) {
        // Add visual feedback when hovering over main category headers
        categorySelect.addEventListener('mouseover', function(e) {
            if (e.target.disabled && e.target.value === '') {
                e.target.style.cursor = 'default';
            }
        });
        
        // Prevent selection of disabled options (main category headers)
        categorySelect.addEventListener('change', function(e) {
            if (e.target.value === '') {
                e.target.value = '';
            }
        });
    }
});
</script>

{% endblock %}
