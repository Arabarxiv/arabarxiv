{% extends 'main/base.html' %}

{% load crispy_forms_tags %}
{% load my_filters %}
{% block title %}Create a Post{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header text-white" style="background-color: #005109;">
          <h1 class="text-center mb-0">تقديم منشور أصلي</h1>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Title field -->
            <div class="form-group mb-4">
              <label for="{{ form.title.id_for_label }}" class="form-label fw-bold text-dark">{{ form.title.label }}</label>
              {{ form.title|add_class:"form-control form-control-lg" }}
              {% if form.title.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.title.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Authors field with custom dropdown -->
            <div class="form-group mb-4">
              <label for="authors-dropdown" class="form-label fw-bold text-dark">هل لديك مؤلفون آخرون لإضافتهم؟</label>
              <div class="dropdown">
                <button class="btn btn-outline-success dropdown-toggle w-100" type="button" id="authors-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="border-color: #005109; color: #005109;">
                  <i class="fas fa-users me-2"></i>اختر المؤلفين الإضافيين (اختياري)
                </button>
                <div class="dropdown-menu w-100" id="authors-dropdown-menu" style="max-height: 200px; overflow-y: auto; background-color: white; color: #212529;">
                  <!-- Users will be loaded here via AJAX -->
                </div>
              </div>
              <div id="selected-authors" class="mt-3">
                <!-- Selected authors will be displayed here -->
              </div>
              <!-- Hidden input to store selected author IDs -->
              <input type="hidden" name="authors" id="authors-input" value="">
            </div>

            <!-- Description field -->
            <div class="form-group mb-4">
              <label for="{{ form.description.id_for_label }}" class="form-label fw-bold text-dark">{{ form.description.label }}</label>
              {{ form.description|add_class:"form-control" }}
              {% if form.description.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.description.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Keywords field -->
            <div class="form-group mb-4">
              <label for="{{ form.keywords.id_for_label }}" class="form-label fw-bold text-dark">{{ form.keywords.label }}</label>
              {{ form.keywords|add_class:"form-control" }}
              {% if form.keywords.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.keywords.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Category field -->
            <div class="form-group mb-4">
              <label for="{{ form.category.id_for_label }}" class="form-label fw-bold text-dark">{{ form.category.label }}</label>
              {{ form.category|add_class:"form-control" }}
              {% if form.category.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.category.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- External DOI field -->
            <div class="form-group mb-4">
              <label for="{{ form.external_doi.id_for_label }}" class="form-label fw-bold text-dark">{{ form.external_doi.label }}</label>
              {{ form.external_doi|add_class:"form-control" }}
              {% if form.external_doi.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.external_doi.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- PDF field -->
            <div class="form-group mb-4">
              <label for="{{ form.pdf.id_for_label }}" class="form-label fw-bold text-dark">
                <i class="fas fa-file-pdf me-2"></i>{{ form.pdf.label }}
              </label>
              <div class="custom-file">
                {{ form.pdf|add_class:"form-control" }}
                <div class="mt-2">
                  <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    {{ form.pdf.help_text }}
                  </small>
                </div>
              </div>
              {% if form.pdf.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.pdf.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            
                         <div class="d-grid gap-2">
               <button type="submit" name="save_draft" class="btn btn-secondary btn-lg">
                 <i class="fas fa-save me-2"></i>حفظ كمسودة
               </button>
               <button type="submit" class="btn btn-success btn-lg">
                 <i class="fas fa-paper-plane me-2"></i>تقديم المقال
               </button>
             </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const authorsDropdown = document.getElementById('authors-dropdown');
    const authorsDropdownMenu = document.getElementById('authors-dropdown-menu');
    const selectedAuthorsDiv = document.getElementById('selected-authors');
    const authorsInput = document.getElementById('authors-input');
    let selectedAuthors = [];

    // Load users when dropdown is clicked
    authorsDropdown.addEventListener('click', function() {
        if (authorsDropdownMenu.children.length === 0) {
            loadUsers();
        }
    });

    function loadUsers() {
        fetch('/get-users/')
            .then(response => response.json())
            .then(data => {
                authorsDropdownMenu.innerHTML = '';
                
                if (data.users.length === 0) {
                    const noUsersItem = document.createElement('div');
                    noUsersItem.className = 'dropdown-item text-muted';
                    noUsersItem.textContent = 'لا يوجد مستخدمون متاحون';
                    authorsDropdownMenu.appendChild(noUsersItem);
                } else {
                    data.users.forEach(user => {
                        const userItem = document.createElement('a');
                        userItem.className = 'dropdown-item';
                        userItem.href = '#';
                        userItem.textContent = user.name;
                        userItem.dataset.userId = user.id;
                        userItem.dataset.userName = user.name;
                        
                        userItem.addEventListener('click', function(e) {
                            e.preventDefault();
                            addAuthor(user.id, user.name);
                        });
                        
                        authorsDropdownMenu.appendChild(userItem);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading users:', error);
                authorsDropdownMenu.innerHTML = '<div class="dropdown-item text-danger">خطأ في تحميل المستخدمين</div>';
            });
    }

    function addAuthor(userId, userName) {
        // Check if author is already selected
        if (selectedAuthors.find(author => author.id === userId)) {
            return;
        }

        selectedAuthors.push({ id: userId, name: userName });
        updateSelectedAuthorsDisplay();
        updateHiddenInput();
    }

    function removeAuthor(userId) {
        selectedAuthors = selectedAuthors.filter(author => author.id !== userId);
        updateSelectedAuthorsDisplay();
        updateHiddenInput();
    }

    function updateSelectedAuthorsDisplay() {
        selectedAuthorsDiv.innerHTML = '';
        
        if (selectedAuthors.length === 0) {
            selectedAuthorsDiv.innerHTML = '<small class="text-muted"><i class="fas fa-info-circle me-1"></i>لم يتم اختيار مؤلفين إضافيين</small>';
            return;
        }

        selectedAuthors.forEach(author => {
            const authorTag = document.createElement('span');
            authorTag.className = 'badge me-2 mb-2 p-2';
            authorTag.style.backgroundColor = '#005109';
            authorTag.style.color = 'white';
            authorTag.innerHTML = `
                <i class="fas fa-user me-1"></i>${author.name}
                <button type="button" class="btn btn-sm btn-outline-light ms-2" onclick="removeAuthorById(${author.id})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            selectedAuthorsDiv.appendChild(authorTag);
        });
    }

    function updateHiddenInput() {
        const authorIds = selectedAuthors.map(author => author.id);
        authorsInput.value = authorIds.join(',');
    }

    // Make removeAuthorById available globally
    window.removeAuthorById = removeAuthor;

    // Initialize display
    updateSelectedAuthorsDisplay();
});
</script>
{% endblock %}
