{% extends 'main/base.html' %}

{% load crispy_forms_tags %}
{% load my_filters %}
{% block title %}تقديم منشور ترجمة{% endblock title %}

{% block content %}
<style>
  /* Custom styling for grouped category dropdown */
  select option[disabled] {
    font-weight: bold;
    background-color: #e9ecef;
    color: #495057;
    padding: 8px 12px;
    border-bottom: 1px solid #dee2e6;
  }
  
  select option:not([disabled]) {
    padding-left: 20px;
    background-color: white;
  }
  
  select option:not([disabled]):hover {
    background-color: #f8f9fa;
  }
</style>
<div class="container">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card shadow">
          <div class="card-header text-white" style="background-color: #005109;">
            <h1 class="text-center mb-0">تقديم منشور ترجمة</h1>
          </div>
          <div class="card-body">
            <form method="post" enctype="multipart/form-data" class="text-right">
                {% csrf_token %}
                
                <!-- Title field -->
                <div class="form-group mb-4">
                  <label for="{{ form.title.id_for_label }}" class="form-label fw-bold text-dark">{{ form.title.label }}</label>
                  {{ form.title|add_class:"form-control form-control-lg" }}
                  {% if form.title.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.title.errors %}
                        {{ error }}
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                                 <!-- Original Author field -->
                 <div class="form-group mb-4">
                   <label for="{{ form.original_author.id_for_label }}" class="form-label fw-bold text-dark">
                     <i class="fas fa-user me-2"></i>{{ form.original_author.label }}
                   </label>
                   {{ form.original_author|add_class:"form-control" }}
                   <div class="mt-2">
                     <small class="text-muted">
                       <i class="fas fa-info-circle me-1"></i>
                       {{ form.original_author.help_text }}
                     </small>
                   </div>
                   {% if form.original_author.errors %}
                     <div class="invalid-feedback d-block">
                       {% for error in form.original_author.errors %}
                         {{ error }}
                       {% endfor %}
                     </div>
                   {% endif %}
                 </div>

                 <!-- Additional Translators field with custom dropdown -->
                 <div class="form-group mb-4">
                   <label for="translators-dropdown" class="form-label fw-bold text-dark">هل لديك مترجمون آخرون لإضافتهم؟</label>
                   <div class="dropdown">
                     <button class="btn btn-outline-success dropdown-toggle w-100" type="button" id="translators-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="border-color: #005109; color: #005109;">
                       <i class="fas fa-language me-2"></i>اختر المترجمين الإضافيين (اختياري)
                     </button>
                     <div class="dropdown-menu w-100" id="translators-dropdown-menu" style="max-height: 300px; overflow-y: auto; background-color: white; color: #212529;">
                       <!-- Search bar -->
                       <div class="p-2 border-bottom">
                         <input type="text" class="form-control form-control-sm" id="translators-search" placeholder="ابحث عن المستخدمين..." style="border-color: #005109;">
                       </div>
                       <!-- Users will be loaded here via AJAX -->
                       <div id="translators-list">
                         <!-- Users list will be populated here -->
                       </div>
                     </div>
                   </div>
                   <div class="mt-2">
                     <small class="text-muted">
                       <i class="fas fa-info-circle me-1"></i>
                       <strong>ملاحظة:</strong> يمكن إضافة المستخدمين المسجلين فقط كمترجمين مشاركين
                     </small>
                   </div>
                   <div id="selected-translators" class="mt-3">
                     <!-- Selected translators will be displayed here -->
                   </div>
                   <!-- Hidden input to store selected translator IDs -->
                   <input type="hidden" name="translators" id="translators-input" value="">
                 </div>

                <!-- Description field -->
                <div class="form-group mb-4">
                  <label for="{{ form.description.id_for_label }}" class="form-label fw-bold text-dark">{{ form.description.label }}</label>
                  {{ form.description|add_class:"form-control" }}
                  {% if form.description.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.description.errors %}
                        {{ error }}
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Keywords field -->
                <div class="form-group mb-4">
                  <label for="{{ form.keywords.id_for_label }}" class="form-label fw-bold text-dark">{{ form.keywords.label }}</label>
                  {{ form.keywords|add_class:"form-control" }}
                  {% if form.keywords.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.keywords.errors %}
                        {{ error }}
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Primary Category field -->
                <div class="form-group mb-4">
                  <label for="{{ form.category.id_for_label }}" class="form-label fw-bold text-dark">{{ form.category.label }}</label>
                  {{ form.category|safe }}
                  <div class="mt-2">
                    <small class="text-muted">
                      <i class="fas fa-info-circle me-1"></i>
                      {{ form.category.help_text }}
                    </small>
                  </div>
                  {% if form.category.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.category.errors %}
                        {{ error }}
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Secondary Category field -->
                <div class="form-group mb-4">
                  <label for="{{ form.second_category.id_for_label }}" class="form-label fw-bold text-dark">{{ form.second_category.label }}</label>
                  {{ form.second_category|safe }}
                  <div class="mt-2">
                    <small class="text-muted">
                      <i class="fas fa-info-circle me-1"></i>
                      {{ form.second_category.help_text }}
                    </small>
                  </div>
                  {% if form.second_category.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.second_category.errors %}
                        {{ error }}
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- External DOI field -->
                <div class="form-group mb-4">
                  <label for="{{ form.external_doi.id_for_label }}" class="form-label fw-bold text-dark">{{ form.external_doi.label }}</label>
                  {{ form.external_doi|add_class:"form-control" }}
                  {% if form.external_doi.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.external_doi.errors %}
                        {{ error }}
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- PDF field -->
                <div class="form-group mb-4">
                  <label for="{{ form.pdf.id_for_label }}" class="form-label fw-bold text-dark">
                    <i class="fas fa-file-pdf me-2"></i>{{ form.pdf.label }}
                  </label>
                  <div class="custom-file">
                    {{ form.pdf|add_class:"form-control" }}
                    <div class="mt-2">
                      <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        {{ form.pdf.help_text }}
                      </small>
                    </div>
                  </div>
                  {% if form.pdf.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.pdf.errors %}
                        {{ error }}
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <div class="d-grid gap-2">
                  <button type="submit" name="save_draft" class="btn btn-secondary btn-lg">
                    <i class="fas fa-save me-2"></i>حفظ كمسودة
                  </button>
                  <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-paper-plane me-2"></i>تقديم الترجمة
                  </button>
                </div>
            </form>
        </div>
        </div>
    </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const translatorsDropdown = document.getElementById('translators-dropdown');
    const translatorsDropdownMenu = document.getElementById('translators-dropdown-menu');
    const translatorsList = document.getElementById('translators-list');
    const translatorsSearch = document.getElementById('translators-search');
    const selectedTranslatorsDiv = document.getElementById('selected-translators');
    const translatorsInput = document.getElementById('translators-input');
    let selectedTranslators = [];
    let allUsers = [];

    // Load users when dropdown is clicked
    translatorsDropdown.addEventListener('click', function() {
        if (translatorsList.children.length === 0) {
            loadUsers();
        }
    });

    // Search functionality
    translatorsSearch.addEventListener('input', function() {
        filterUsers(this.value);
    });

    function loadUsers() {
        fetch('/get-users/')
            .then(response => response.json())
            .then(data => {
                allUsers = data.users;
                displayUsers(allUsers);
            })
            .catch(error => {
                console.error('Error loading users:', error);
                translatorsList.innerHTML = '<div class="dropdown-item text-danger">خطأ في تحميل المستخدمين</div>';
            });
    }

    function displayUsers(users) {
        translatorsList.innerHTML = '';
        
        if (users.length === 0) {
            const noUsersItem = document.createElement('div');
            noUsersItem.className = 'dropdown-item text-muted';
            noUsersItem.textContent = 'لا يوجد مستخدمون متاحون';
            translatorsList.appendChild(noUsersItem);
        } else {
            users.forEach(user => {
                const userItem = document.createElement('a');
                userItem.className = 'dropdown-item';
                userItem.href = '#';
                userItem.textContent = user.name;
                userItem.dataset.userId = user.id;
                userItem.dataset.userName = user.name;
                
                userItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    addTranslator(user.id, user.name);
                });
                
                translatorsList.appendChild(userItem);
            });
        }
    }

    function filterUsers(searchTerm) {
        const filteredUsers = allUsers.filter(user => 
            user.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
        displayUsers(filteredUsers);
    }

    function addTranslator(userId, userName) {
        // Check if translator is already selected
        if (selectedTranslators.find(translator => translator.id === userId)) {
            return;
        }

        selectedTranslators.push({ id: userId, name: userName });
        updateSelectedTranslatorsDisplay();
        updateHiddenInput();
    }

    function removeTranslator(userId) {
        selectedTranslators = selectedTranslators.filter(translator => translator.id !== userId);
        updateSelectedTranslatorsDisplay();
        updateHiddenInput();
    }

    function updateSelectedTranslatorsDisplay() {
        selectedTranslatorsDiv.innerHTML = '';
        
        if (selectedTranslators.length === 0) {
            selectedTranslatorsDiv.innerHTML = '<small class="text-muted"><i class="fas fa-info-circle me-1"></i>لم يتم اختيار مترجمين إضافيين</small>';
            return;
        }

        selectedTranslators.forEach(translator => {
            const translatorTag = document.createElement('span');
            translatorTag.className = 'badge me-2 mb-2 p-2';
            translatorTag.style.backgroundColor = '#005109';
            translatorTag.style.color = 'white';
            translatorTag.innerHTML = `
                <i class="fas fa-language me-1"></i>${translator.name}
                <button type="button" class="btn btn-sm btn-outline-light ms-2" onclick="removeTranslatorById(${translator.id})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            selectedTranslatorsDiv.appendChild(translatorTag);
        });
    }

    function updateHiddenInput() {
        const translatorIds = selectedTranslators.map(translator => translator.id);
        translatorsInput.value = translatorIds.join(',');
    }

    // Make removeTranslatorById available globally
    window.removeTranslatorById = removeTranslator;

    // Initialize display
    updateSelectedTranslatorsDisplay();
});

// Enhanced category dropdown functionality
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.querySelector('select[name="category"]');
    const secondCategorySelect = document.querySelector('select[name="second_category"]');
    
    if (categorySelect) {
        // Add visual feedback when hovering over main category headers
        categorySelect.addEventListener('mouseover', function(e) {
            if (e.target.disabled && e.target.value === '') {
                e.target.style.cursor = 'default';
            }
        });
        
        // Prevent selection of disabled options (main category headers)
        categorySelect.addEventListener('change', function(e) {
            if (e.target.value === '') {
                e.target.value = '';
            }
            // Update second category options
            updateSecondCategoryOptions();
        });
    }
    
    if (secondCategorySelect) {
        // Add visual feedback when hovering over main category headers
        secondCategorySelect.addEventListener('mouseover', function(e) {
            if (e.target.disabled && e.target.value === '') {
                e.target.style.cursor = 'default';
            }
        });
        
        // Prevent selection of disabled options (main category headers)
        secondCategorySelect.addEventListener('change', function(e) {
            if (e.target.value === '') {
                e.target.value = '';
            }
        });
    }
    
    function updateSecondCategoryOptions() {
        if (!categorySelect || !secondCategorySelect) return;
        
        const selectedCategory = categorySelect.value;
        const currentSecondCategory = secondCategorySelect.value;
        
        // Reset second category if it matches the primary category
        if (selectedCategory && currentSecondCategory === selectedCategory) {
            secondCategorySelect.value = '';
        }
        
        // Disable the selected primary category in the second dropdown
        Array.from(secondCategorySelect.options).forEach(option => {
            if (option.value === selectedCategory && option.value !== '') {
                option.disabled = true;
                option.style.display = 'none';
            } else if (option.disabled && option.value !== '') {
                option.disabled = false;
                option.style.display = '';
            }
        });
    }
    
    // Initialize on page load
    updateSecondCategoryOptions();
});
</script>
{% endblock content %}
