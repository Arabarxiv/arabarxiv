{% extends 'main/base.html' %}
{% load my_filters %}

{% block title %}مراجعة المشاركات{% endblock %}

{% block content %}
<style>
     .alert-info {
        background-color: #b8e6bd;
        margin-top:20px; 
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .custom-btn {
        background-color: #005109;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    
    .custom-btn:hover {
        background-color: darkgreen;
    }
    
    /* File link styling for original vs translated posts */
    .original-file-link {
        color: #007bff; /* Blue for original posts */
        text-decoration: none;
        font-weight: bold;
    }
    
    .original-file-link:hover {
        color: #0056b3;
        text-decoration: underline;
    }
    
    .translated-file-link {
        color: #dc3545; /* Light red for translated posts */
        text-decoration: none;
        font-weight: bold;
    }
    
    .translated-file-link:hover {
        color: #c82333;
        text-decoration: underline;
    }
    
    .post-type-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        text-align: center;
        display: inline-block;
        min-width: 80px;
    }
    
    .post-type-original {
        background-color: #007bff;
        color: white;
    }
    
    .post-type-translation {
        background-color: #dc3545;
        color: white;
    }
    
    .badge-success {
        background-color: #28a745;
        color: white;
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 12px;
        margin-top: 5px;
        display: inline-block;
    }
    
    .badge-warning {
        background-color: #ffc107;
        color: #212529;
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 12px;
        margin-top: 5px;
        display: inline-block;
    }
    
    /* Text containment for table cells */
    .table td {
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Only apply hover effect to specific content that needs it */
    .table td:hover .reviewer-comments,
    .table td:hover .admin-comments {
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 300px;
    }
    
    .table th {
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 150px;
    }
    
    /* Specific styling for content that should wrap */
    .table td .reviewer-comments,
    .table td .admin-comments {
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 250px;
        overflow: hidden;
    }
    
    /* Select2 RTL Support */
    .select2-container--default .select2-selection--single {
        text-align: right;
        direction: rtl;
        border: 2px solid #28a745; /* Green border like screenshot */
        border-radius: 5px;
        height: 40px;
        line-height: 1.5;
        background-color: #fff;
        transition: all 0.3s ease;
    }
    
    .select2-container--default .select2-selection--single:hover {
        border-color: #218838;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    .select2-container--default .select2-results__option {
        text-align: right;
        direction: rtl;
        padding: 8px 12px;
    }
    
    .select2-search__field {
        text-align: right;
        direction: rtl;
        padding: 10px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .select2-search__field:focus {
        outline: none;
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        text-align: right;
        direction: rtl;
        padding: 6px 12px;
        line-height: 40px;
        color: #495057;
        font-weight: 500;
    }
    
    /* Ensure Select2 dropdown appears above other elements */
    .select2-container--open {
        z-index: 9999;
    }
    
    /* Enhanced dropdown styling */
    .select2-dropdown {
        border: 2px solid #28a745;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #28a745;
        color: white;
    }
    
    .select2-container--default .select2-results__option[aria-selected=true] {
        background-color: #e8f5e8;
        color: #28a745;
    }
    
    /* Fix Bootstrap conflicts */
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 40px;
        right: auto;
        left: 6px;
        width: 20px;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow b {
        border-color: #28a745 transparent transparent transparent;
        border-style: solid;
        border-width: 5px 4px 0 4px;
        height: 0;
        left: 50%;
        margin-left: -4px;
        margin-top: -2px;
        position: absolute;
        top: 50%;
        width: 0;
    }
    
         /* Ensure proper width */
     .select2-container {
         width: 100% !important;
     }
     
                                                                                                                                                                           
     </style>

{# Show Django messages #}
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} text-center" role="alert" style="margin-bottom: 0;">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

{% if not user.is_staff and not user in moderators and not user.is_superuser %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
        <div class="alert alert-info">
            <h2>هل ترغب في أن تصبح مراجعًا؟</h2>
            <p>إذا كنت ترغب في المساعدة في مراجعة المشاركات، يرجى ملء النموذج التالي.</p>
            <form method="post" action="/become_reviewer">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">أود أن أصبح مراجعًا</button>
            </form>
        </div></div>
    </div>
</div>
{% elif not is_author and not user.is_superuser %}
 <!-- Message for users who do not have any accepted papers -->
 <div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="alert alert-info">
                <h2>قدم بحثك الأول</h2>
                <p>قم بتقديم بحثك الأول وسيكون لديك فرصة لتصبح مراجعًا والانضمام إلى مجتمع أراب أركسيف!</p>
            </div>
        </div>
    </div>
</div>
{% else %}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- قائمة المشاركات المعينة للمراجعة -->
            <h1>المشاركات المعينة للمراجعة</h1>
{% if posts %}
<table class="table">
    <thead>
        <tr>
            <th>العنوان</th>
            <th>المؤلفين</th>
            <th>نوع المشاركة</th>
            <th>رابط الـ PDF</th>
            <th>الإجراءات</th>
        </tr>
    </thead>
    <tbody>
        {% for post in posts %}
            {% if post.reviewer == user and post.status == "Pending" and not post.review_started %}
                <tr>
                                         <td title="{{ post.title }}">{{ post.title }}</td>
                     <td title="{{ post.authors }}">{{ post.authors }}</td>
                     <td>
                         {% if post|class_name == 'TranslationPost' %}
                             <span class="post-type-badge post-type-translation">ترجمة</span>
                         {% else %}
                             <span class="post-type-badge post-type-original">أصلي</span>
                         {% endif %}
                     </td>
                     <td>
                         {% if post|class_name == 'TranslationPost' %}
                           <a href="{{ post.pdf.url }}" target="_blank" class="translated-file-link">عرض الـ PDF</a>
                         {% else %}
                           <a href="{{ post.pdf.url }}" target="_blank" class="original-file-link">عرض الـ PDF</a>
                         {% endif %}
                     </td>
                                                                                       <td>
                           <form method="post" action="{% url 'start_reviewing' post.id %}" style="display: inline;">
                               {% csrf_token %}
                               <button type="submit" class="btn btn-success">بدء المراجعة</button>
                           </form>
                           
                           <!-- Reject for reassignment button -->
                           <form method="post" action="{% url 'reject_for_reassignment' post.id %}" style="display: inline; margin-right: 10px;">
                               {% csrf_token %}
                               <button type="submit" class="btn btn-danger" onclick="return confirm('هل أنت متأكد من رفض هذه المشاركة لإعادة تعيينها؟')">
                                   رفض لإعادة تعيين
                               </button>
                           </form>
                           
                           {% if post.is_edited_after_approval %}
                               <span class="badge badge-warning" style="margin-left: 10px;">تم التعديل</span>
                           {% endif %}
                       </td>
                </tr>
            {% endif %}
        {% empty %}
            <tr>
                <td colspan="5">
                    <p>لا توجد مشاركات معينة للمراجعة.</p>
                </td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>لا توجد مشاركات معينة للمراجعة.</p>
{% endif %}

            <!-- قائمة المشاركات التي بدأت مراجعتها -->
            <h2 style="margin-top: 40px;">المشاركات التي بدأت مراجعتها</h2>
{% if posts %}
<table class="table">
    <thead>
        <tr>
            <th>العنوان</th>
            <th>المؤلفين</th>
            <th>نوع المشاركة</th>
            <th>رابط الـ PDF</th>
                                      <th>مراجعة</th>
             {% if user.is_staff or user.is_superuser %}
                 <th>التعليق الخاص</th>
             {% endif %}
        </tr>
    </thead>
    <tbody>
        {% for post in posts %}
            {% if post.reviewer == user and post.status == "Pending" and post.review_started %}
                <tr>
                                         <td title="{{ post.title }}">{{ post.title }}</td>
                     <td title="{{ post.authors }}">{{ post.authors }}</td>
                     <td>
                         {% if post|class_name == 'TranslationPost' %}
                             <span class="post-type-badge post-type-translation">ترجمة</span>
                         {% else %}
                             <span class="post-type-badge post-type-original">أصلي</span>
                         {% endif %}
                     </td>
                     <td>
                         {% if post|class_name == 'TranslationPost' %}
                           <a href="{{ post.pdf.url }}" target="_blank" class="translated-file-link">عرض الـ PDF</a>
                         {% else %}
                           <a href="{{ post.pdf.url }}" target="_blank" class="original-file-link">عرض الـ PDF</a>
                         {% endif %}
                     </td>
                                           <td>
                          <a href="{% url 'detailed_review' post.id %}" class="btn btn-primary">مراجعة</a>
                          {% if post.is_edited_after_approval %}
                              <span class="badge badge-warning" style="margin-left: 10px;">تم التعديل</span>
                          {% endif %}
                      </td>
                                         {% if user.is_staff or user.is_superuser %}
                         <td class="admin-comments">{{post.admin_comments}}</td>
                     {% endif %}
                </tr>
            {% endif %}
        {% empty %}
                         <tr>
                 <td colspan="{% if user.is_staff or user.is_superuser %}6{% else %}5{% endif %}">
                     <p>لا توجد مشاركات قيد المراجعة.</p>
                 </td>
             </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>لا توجد مشاركات قيد المراجعة.</p>
{% endif %}

            {% if user.is_staff or user.is_superuser %}
            <h2 style="margin-top: 40px;">المشاركات في انتظار المراجعة</h2>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>عنوان المشاركة</th>
                            <th>المراجعون السابقون</th>
                            <th>اختيار المشرف</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for post in unassigned_posts %}
                            <tr>
                                <td>
                                    <strong>{{ post.title }}</strong>
                                </td>
                                <td>
                                    {% if post.previous_reviewers.all %}
                                        <small class="text-muted">
                                            {% for prev_reviewer in post.previous_reviewers.all %}
                                                {{ prev_reviewer.username }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        </small>
                                    {% else %}
                                        <span class="text-success">جديد</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="post" action="review/assign_mod" id="reviwer_assign_{{ post.id }}" style="margin: 0;">
                                        {% csrf_token %}
                                        <input type="hidden" name="post_id" value="{{ post.id }}">
                                        
                                                                                 <select class="form-control" name="moderator_{{ post.id }}" required>
                                             <option value="">اختر المشرف</option>
                                             {% for moderator in moderators %}
                                                 {% if moderator not in post.previous_reviewers.all %}
                                                     <option value="{{ moderator.id }}">{{ moderator.username }}</option>
                                                 {% else %}
                                                     <option value="{{ moderator.id }}" disabled>{{ moderator.username }} (مراجع سابق)</option>
                                                 {% endif %}
                                             {% endfor %}
                                         </select>
                                    </form>
                                </td>
                                <td>
                                    <button type="submit" form="reviwer_assign_{{ post.id }}" class="btn btn-primary btn-sm">
                                        {% if post.previous_reviewers.all %}
                                            إعادة تعيين
                                        {% else %}
                                            تعيين مشرف
                                        {% endif %}
                                    </button>
                                    
                                    {% if post.status == 'Rejected_For_Reassignment' %}
                                        <small class="text-danger d-block">تم رفضها</small>
                                    {% elif post.previous_reviewers.all %}
                                        <small class="text-warning d-block">طلب إعادة مراجعة</small>
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">
                                    <div class="alert alert-info mb-0">
                                        لا توجد مشاركات في انتظار المراجعة.
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
        {% endif %}
        
        </div>
    </div>
</div>
{% endif %}

<script>
// Wait for both jQuery and Select2 to be available
function initializeSelect2() {
    console.log('Attempting to initialize Select2...');
    console.log('jQuery version:', $.fn.jquery);
    console.log('Select2 available:', typeof $.fn.select2 !== 'undefined');
    
    // Check if Select2 is available
    if (typeof $.fn.select2 === 'undefined') {
        console.error('Select2 is not loaded! Waiting...');
        setTimeout(initializeSelect2, 100);
        return;
    }
    
    // Check if jQuery is available
    if (typeof $ === 'undefined') {
        console.error('jQuery is not loaded!');
        return;
    }
    
    // Find all select2 elements
    var select2Elements = $('.select2');
    console.log('Found', select2Elements.length, 'Select2 elements');
    
    if (select2Elements.length === 0) {
        console.warn('No .select2 elements found!');
        return;
    }
    
    // Initialize Select2 for all reviewer dropdowns
    try {
        select2Elements.each(function(index, element) {
            console.log('Initializing Select2 for element:', element.id || element.name);
            $(element).select2({
                width: '100%',
                placeholder: "اختر مشرفًا",
                allowClear: true,
                dir: 'rtl',
                language: {
                    noResults: function() {
                        return "لم يتم العثور على مشرف";
                    },
                    searching: function() {
                        return "جاري البحث...";
                    }
                }
            });
        });
        console.log('Select2 initialized successfully for all elements');
    } catch (error) {
        console.error('Error initializing Select2:', error);
    }
}

// Try multiple approaches to ensure initialization
$(document).ready(function() {
    console.log('Document ready, starting Select2 initialization...');
    initializeSelect2();
});

// Also try on window load as backup
$(window).on('load', function() {
    console.log('Window loaded, checking Select2 again...');
    setTimeout(initializeSelect2, 500);
});

// Fallback: try after a delay
setTimeout(function() {
    console.log('Fallback: trying Select2 initialization...');
    initializeSelect2();
}, 1000);


</script>

{% endblock content %}
