{% extends 'main/base.html' %}
{% load my_filters %}

{% block title %}مراجعة المشاركات{% endblock %}

{% block content %}
<style>
     .alert-info {
        background-color: #b8e6bd;
        margin-top:20px; 
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .custom-btn {
        background-color: #005109;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    
    .custom-btn:hover {
        background-color: darkgreen;
    }
    
    /* File link styling for original vs translated posts */
    .original-file-link {
        color: #007bff; /* Blue for original posts */
        text-decoration: none;
        font-weight: bold;
    }
    
    .original-file-link:hover {
        color: #0056b3;
        text-decoration: underline;
    }
    
    .translated-file-link {
        color: #dc3545; /* Light red for translated posts */
        text-decoration: none;
        font-weight: bold;
    }
    
    .translated-file-link:hover {
        color: #c82333;
        text-decoration: underline;
    }
    
    .post-type-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        text-align: center;
        display: inline-block;
        min-width: 80px;
    }
    
    .post-type-original {
        background-color: #007bff;
        color: white;
    }
    
    .post-type-translation {
        background-color: #dc3545;
        color: white;
    }
    
    .badge-success {
        background-color: #28a745;
        color: white;
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 12px;
        margin-top: 5px;
        display: inline-block;
    }
    
    .badge-warning {
        background-color: #ffc107;
        color: #212529;
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 12px;
        margin-top: 5px;
        display: inline-block;
    }
    
    /* Text containment for table cells */
    .table td {
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .table td:hover {
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 300px;
    }
    
    .table th {
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 150px;
    }
    
    /* Specific styling for content that should wrap */
    .table td .reviewer-comments,
    .table td .admin-comments {
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 250px;
        overflow: hidden;
    }
    </style>

{# Show Django messages #}
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} text-center" role="alert" style="margin-bottom: 0;">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

{% if not user.is_staff and not user in moderators and not user.is_superuser %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
        <div class="alert alert-info">
            <h2>هل ترغب في أن تصبح مراجعًا؟</h2>
            <p>إذا كنت ترغب في المساعدة في مراجعة المشاركات، يرجى ملء النموذج التالي.</p>
            <form method="post" action="/become_reviewer">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">أود أن أصبح مراجعًا</button>
            </form>
        </div></div>
    </div>
</div>
{% elif not is_author and not user.is_superuser %}
 <!-- Message for users who do not have any accepted papers -->
 <div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="alert alert-info">
                <h2>قدم بحثك الأول</h2>
                <p>قم بتقديم بحثك الأول وسيكون لديك فرصة لتصبح مراجعًا والانضمام إلى مجتمع أراب أركسيف!</p>
            </div>
        </div>
    </div>
</div>
{% else %}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- قائمة المشاركات المعينة للمراجعة -->
            <h1>المشاركات المعينة للمراجعة</h1>
{% if posts %}
<table class="table">
    <thead>
        <tr>
            <th>العنوان</th>
            <th>المؤلفين</th>
            <th>نوع المشاركة</th>
            <th>رابط الـ PDF</th>
            <th>الإجراءات</th>
        </tr>
    </thead>
    <tbody>
        {% for post in posts %}
            {% if post.reviewer == user and post.status == "Pending" and not post.review_started %}
                <tr>
                                         <td title="{{ post.title }}">{{ post.title }}</td>
                     <td title="{{ post.authors }}">{{ post.authors }}</td>
                     <td>
                         {% if post|class_name == 'TranslationPost' %}
                             <span class="post-type-badge post-type-translation">ترجمة</span>
                         {% else %}
                             <span class="post-type-badge post-type-original">أصلي</span>
                         {% endif %}
                     </td>
                     <td>
                         {% if post|class_name == 'TranslationPost' %}
                           <a href="{{ post.pdf.url }}" target="_blank" class="translated-file-link">عرض الـ PDF</a>
                         {% else %}
                           <a href="{{ post.pdf.url }}" target="_blank" class="original-file-link">عرض الـ PDF</a>
                         {% endif %}
                     </td>
                                           <td>
                          <form method="post" action="{% url 'start_reviewing' post.id %}" style="display: inline;">
                              {% csrf_token %}
                              <button type="submit" class="btn btn-success">بدء المراجعة</button>
                          </form>
                          {% if post.is_edited_after_approval %}
                              <span class="badge badge-warning" style="margin-left: 10px;">تم التعديل</span>
                          {% endif %}
                      </td>
                </tr>
            {% endif %}
        {% empty %}
            <tr>
                <td colspan="5">
                    <p>لا توجد مشاركات معينة للمراجعة.</p>
                </td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>لا توجد مشاركات معينة للمراجعة.</p>
{% endif %}

            <!-- قائمة المشاركات التي بدأت مراجعتها -->
            <h2 style="margin-top: 40px;">المشاركات التي بدأت مراجعتها</h2>
{% if posts %}
<table class="table">
    <thead>
        <tr>
            <th>العنوان</th>
            <th>المؤلفين</th>
            <th>نوع المشاركة</th>
            <th>رابط الـ PDF</th>
                                      <th>مراجعة</th>
             {% if user.is_staff or user.is_superuser %}
                 <th>التعليق الخاص</th>
             {% endif %}
        </tr>
    </thead>
    <tbody>
        {% for post in posts %}
            {% if post.reviewer == user and post.status == "Pending" and post.review_started %}
                <tr>
                                         <td title="{{ post.title }}">{{ post.title }}</td>
                     <td title="{{ post.authors }}">{{ post.authors }}</td>
                     <td>
                         {% if post|class_name == 'TranslationPost' %}
                             <span class="post-type-badge post-type-translation">ترجمة</span>
                         {% else %}
                             <span class="post-type-badge post-type-original">أصلي</span>
                         {% endif %}
                     </td>
                     <td>
                         {% if post|class_name == 'TranslationPost' %}
                           <a href="{{ post.pdf.url }}" target="_blank" class="translated-file-link">عرض الـ PDF</a>
                         {% else %}
                           <a href="{{ post.pdf.url }}" target="_blank" class="original-file-link">عرض الـ PDF</a>
                         {% endif %}
                     </td>
                                           <td>
                          <a href="{% url 'detailed_review' post.id %}" class="btn btn-primary">مراجعة</a>
                          {% if post.is_edited_after_approval %}
                              <span class="badge badge-warning" style="margin-left: 10px;">تم التعديل</span>
                          {% endif %}
                      </td>
                                         {% if user.is_staff or user.is_superuser %}
                         <td class="admin-comments">{{post.admin_comments}}</td>
                     {% endif %}
                </tr>
            {% endif %}
        {% empty %}
                         <tr>
                 <td colspan="{% if user.is_staff or user.is_superuser %}6{% else %}5{% endif %}">
                     <p>لا توجد مشاركات قيد المراجعة.</p>
                 </td>
             </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>لا توجد مشاركات قيد المراجعة.</p>
{% endif %}

            {% if user.is_staff or user.is_superuser %}
            <h2 style="margin-top: 40px;">المشاركات في انتظار المراجعة</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>عنوان المشاركة</th>
                            <th>تحديد مشرف</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for post in unassigned_posts %}
                            <tr>
                                    <form method="post" action="review/assign_mod" id="reviwer_assign">
                                        {% csrf_token %}
                                    <td>{{ post.title }}</td>
                                                                         <td>
                                         <div class="form-group">
                                             <select class="form-control" name="moderator_{{ post.id }}" required>
                                                 <option value="">اختر مشرفًا</option>
                                                 {% for moderator in moderators %}
                                                     {% if moderator not in post.previous_reviewers.all %}
                                                         <option value="{{ moderator.id }}" {% if post.reviewer == moderator %}selected{% endif %}>{{ moderator.username }}</option>
                                                     {% else %}
                                                         <option value="{{ moderator.id }}" disabled>{{ moderator.username }} (مراجع سابق)</option>
                                                     {% endif %}
                                                 {% endfor %}
                                             </select>
                                             <input type="hidden" name="post_id" value="{{ post.id }}">
                                             {% if post.previous_reviewers.all %}
                                                 <small class="text-muted">المراجعون السابقون: 
                                                     {% for prev_reviewer in post.previous_reviewers.all %}
                                                         {{ prev_reviewer.username }}{% if not forloop.last %}, {% endif %}
                                                     {% endfor %}
                                                 </small>
                                             {% endif %}
                                         </div>
                                     </td>
                                    <td>
                                        {% if post.previous_reviewers.all %}
                                            <button type="submit" class="btn btn-warning">إعادة تعيين مشرف</button>
                                            <small class="text-muted d-block">طلب إعادة مراجعة</small>
                                        {% else %}
                                            <button type="submit" class="btn btn-primary">تعيين مشرف</button>
                                        {% endif %}
                                    </td>
                                </form>
                                </tr>
                        {% empty %}
                            <tr>
                                <td colspan="3">
                                    <p>لا توجد مشاركات في انتظار المراجعة.</p>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            
        {% endif %}
        
        </div>
    </div>
</div>
{% endif %}
{% endblock content %}
